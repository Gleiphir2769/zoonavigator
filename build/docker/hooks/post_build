#!/bin/bash

# Exit if command fails
set -e

# Remember current wd
wd=$(pwd)

# ----------
# Build Snap
# ----------

# Is docker tag semver?
if [[ $DOCKER_TAG =~ ^[0-9]+(\.[0-9]+){2,3}$ ]];
then
  cd "$wd/../snap"

  # Copy app files
  id=$(docker create $IMAGE_NAME)
  docker cp $id:/app ./app
  docker rm -v $id

  # Set Snap version
  echo "$DOCKER_TAG" > ./app/version

  # Build Snapcraft Docker image
  wget https://raw.githubusercontent.com/snapcore/snapcraft/master/docker/stable.Dockerfile

  docker build \
    --no-cache \
    --network host \
    -f stable.Dockerfile \
    -t snapcraft:stable \
    .

  # Build Snap
  docker run \
    -v "$PWD":/build \
    -w /build \
    snapcraft:stable \
    snapcraft
fi
